---
- name: Configure passwordless sudo for operators
  hosts: "{{ sudo_targets | default('homelab_hosts') }}"
  become: true
  gather_facts: false

  vars:
    sudo_operator: "{{ sudo_username | default('', true) | trim }}"
    sudoers_dropin_path: "/etc/sudoers.d/{{ sudo_operator }}"
    sudoers_template: "{{ playbook_dir }}/templates/sudoers_user.j2"

  pre_tasks:
    - name: Ensure sudo_username is provided
      ansible.builtin.assert:
        that:
          - sudo_operator | length > 0
        fail_msg: "Define sudo_username (e.g. -e sudo_username=admin)"
      run_once: true

    - name: Ensure user {{ sudo_operator }} exists
      ansible.builtin.getent:
        database: passwd
        key: "{{ sudo_operator }}"

  tasks:
    - name: Ensure sudo is installed
      ansible.builtin.package:
        name: sudo
        state: present

    - name: Deploy sudoers drop-in
      ansible.builtin.template:
        src: "{{ sudoers_template }}"
        dest: "{{ sudoers_dropin_path }}"
        owner: root
        group: root
        mode: "0440"
      vars:
        sudo_sudoers_user: "{{ sudo_operator }}"

    - name: Validate sudoers syntax
      ansible.builtin.command: "visudo -cf {{ sudoers_dropin_path }}"
      changed_when: false
