---
- name: Install and configure Docker Engine
  hosts: "{{ setup_targets }}"
  become: true
  gather_facts: true

  vars:
    docker_users: []
    docker_repo_base_url: "https://download.docker.com/linux/{{ ansible_distribution | lower }}"
    docker_arch_map:
      aarch64: arm64
      arm64: arm64
      armv7l: armhf
      armhf: armhf
      x86_64: amd64
      amd64: amd64
    docker_apt_arch: "{{ docker_arch_map[ansible_architecture] | default('amd64') }}"
    docker_repo: >-
      deb [arch={{ docker_apt_arch }} signed-by=/etc/apt/keyrings/docker.asc]
      {{ docker_repo_base_url }} {{ ansible_distribution_release }} stable

  pre_tasks:
    - name: Ensure Debian-based distribution
      ansible.builtin.assert:
        that:
          - ansible_os_family == "Debian"
        fail_msg: "This playbook currently supports Debian-based distributions only."

  tasks:
    - name: Install prerequisite packages
      ansible.builtin.apt:
        name:
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present
        update_cache: true

    - name: Ensure APT keyring directory exists
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"

    - name: Check Docker GPG key presence
      ansible.builtin.stat:
        path: /etc/apt/keyrings/docker.asc
      register: docker_gpg

    - name: Download Docker GPG key
      ansible.builtin.get_url:
        url: "{{ docker_repo_base_url }}/gpg"
        dest: /etc/apt/keyrings/docker.asc
        mode: "0644"
      when: not docker_gpg.stat.exists

    - name: Configure Docker APT repository
      ansible.builtin.apt_repository:
        repo: "{{ docker_repo }}"
        filename: docker
        state: present

    - name: Install Docker packages
      ansible.builtin.apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: true

    - name: Ensure Docker daemon is enabled
      ansible.builtin.service:
        name: docker
        enabled: true
        state: started

    - name: Add users to docker group
      when: docker_users | length > 0
      ansible.builtin.user:
        name: "{{ item }}"
        groups: docker
        append: true
      loop: "{{ docker_users }}"
